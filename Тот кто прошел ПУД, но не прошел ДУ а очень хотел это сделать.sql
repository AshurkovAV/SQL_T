SELECT MAX(d.id)id, d.FAM, d.IM, d.OT, d.dr
INTO ztemp_du_051023_2
FROM
(SELECT dzo.ID, dpo.FAM, dpo.IM, dpo.OT, dr
FROM D3_ZSL_OMS AS dzo
JOIN D3_SL_OMS AS dso ON dso.D3_ZSLID = dzo.ID
JOIN D3_PACIENT_OMS AS dpo ON dpo.ID = dzo.D3_PID
JOIN D3_SCHET_OMS AS dso2 ON dso2.ID = dzo.D3_SCID
WHERE dso2.[YEAR] = 2023 AND dso2.[MONTH] = 9
AND dzo.OS_SLUCH_REGION IN (47,49, 50)
 AND dso.PROFIL IN (97, 29, 53)
AND( dso.DS1 IN ('I27.0', 'I27.2', 'I27.8', 'I50.0', 'I50.1', 'I50.9', 'I51.4', 'I69.0','I69.1','I69.2','I69.3','I69.4','I67.8', 'I65.2',
'Z95.0', 'Z95.1', 'Z95.2', 'Z95.3', 'Z95.4','Z95.5', 'Z95.8', 'Z95.9') OR
dso.DS1 BETWEEN 'I05' AND 'I05.9' OR
dso.DS1 BETWEEN 'I06' AND 'I06.9' OR
dso.DS1 BETWEEN 'I07' AND 'I07.9' OR
dso.DS1 BETWEEN 'I08' AND 'I08.9' OR
dso.DS1 BETWEEN 'I09' AND 'I09.9' OR

dso.DS1 BETWEEN 'I10' AND 'I10.9' OR 
dso.DS1 BETWEEN 'I11' AND 'I11.9' OR 
dso.DS1 BETWEEN 'I12' AND 'I12.9' OR 
dso.DS1 BETWEEN 'I13' AND 'I13.9' OR 
dso.DS1 BETWEEN 'I15' AND 'I15.9' OR
dso.DS1 BETWEEN 'I20' AND 'I20.9' OR
dso.DS1 BETWEEN 'I21' AND 'I21.9' OR
dso.DS1 BETWEEN 'I22' AND 'I22.9' OR
dso.DS1 BETWEEN 'I23' AND 'I23.9' OR
dso.DS1 BETWEEN 'I24' AND 'I24.9' OR
dso.DS1 BETWEEN 'I25' AND 'I25.9' OR
dso.DS1 BETWEEN 'I26' AND 'I26.9' OR
dso.DS1 BETWEEN 'I28' AND 'I28.9' OR
dso.DS1 BETWEEN 'I33' AND 'I33.9' OR
dso.DS1 BETWEEN 'I34' AND 'I34.9' OR
dso.DS1 BETWEEN 'I35' AND 'I35.9' OR
dso.DS1 BETWEEN 'I36' AND 'I36.9' OR
dso.DS1 BETWEEN 'I37' AND 'I37.9' OR
dso.DS1 BETWEEN 'I38' AND 'I38.9' OR
dso.DS1 BETWEEN 'I39' AND 'I39.9' OR
dso.DS1 BETWEEN 'I40' AND 'I40.9' OR
dso.DS1 BETWEEN 'I41' AND 'I41.9' OR
dso.DS1 BETWEEN 'I42' AND 'I42.9' OR
dso.DS1 BETWEEN 'I44' AND 'I44.9' OR
dso.DS1 BETWEEN 'I45' AND 'I45.9' OR
dso.DS1 BETWEEN 'I46' AND 'I46.9' OR
dso.DS1 BETWEEN 'I47' AND 'I47.9' OR
dso.DS1 BETWEEN 'I48' AND 'I48.9' OR
dso.DS1 BETWEEN 'I49' AND 'I49.9' OR
dso.DS1 BETWEEN 'I51' AND 'I51.2' OR
dso.DS1 BETWEEN 'I71' AND 'I71.9' OR
dso.DS1 BETWEEN 'Q20' AND 'Q28.9' OR
dso.DS1 BETWEEN 'E78' AND 'E78.9' 
)

) AS d 
LEFT JOIN 
(SELECT dpo.FAM, dpo.IM, dpo.OT, dr
FROM D3_ZSL_OMS AS dzo
JOIN D3_SL_OMS AS dso ON dso.D3_ZSLID = dzo.ID
JOIN D3_SCHET_OMS AS dso2 ON dso2.ID = dzo.D3_SCID
JOIN D3_PACIENT_OMS AS dpo ON dpo.ID = dzo.D3_PID
left JOIN D3_USL_OMS AS duo ON duo.D3_SLID = dso.ID
WHERE dzo.D3_SCID  IN (20530, 20568)
AND dso.P_CEL25 IN( '1.3', '1.0')
 AND dso.PROFIL IN (97, 29, 53)
AND( dso.DS1 IN ('I27.0', 'I27.2', 'I27.8', 'I50.0', 'I50.1', 'I50.9', 'I51.4', 'I69.0','I69.1','I69.2','I69.3','I69.4','I67.8', 'I65.2',
'Z95.0', 'Z95.1', 'Z95.2', 'Z95.3', 'Z95.4','Z95.5', 'Z95.8', 'Z95.9') OR
dso.DS1 BETWEEN 'I05' AND 'I05.9' OR
dso.DS1 BETWEEN 'I06' AND 'I06.9' OR
dso.DS1 BETWEEN 'I07' AND 'I07.9' OR
dso.DS1 BETWEEN 'I08' AND 'I08.9' OR
dso.DS1 BETWEEN 'I09' AND 'I09.9' OR

dso.DS1 BETWEEN 'I10' AND 'I10.9' OR 
dso.DS1 BETWEEN 'I11' AND 'I11.9' OR 
dso.DS1 BETWEEN 'I12' AND 'I12.9' OR 
dso.DS1 BETWEEN 'I13' AND 'I13.9' OR 
dso.DS1 BETWEEN 'I15' AND 'I15.9' OR
dso.DS1 BETWEEN 'I20' AND 'I20.9' OR
dso.DS1 BETWEEN 'I21' AND 'I21.9' OR
dso.DS1 BETWEEN 'I22' AND 'I22.9' OR
dso.DS1 BETWEEN 'I23' AND 'I23.9' OR
dso.DS1 BETWEEN 'I24' AND 'I24.9' OR
dso.DS1 BETWEEN 'I25' AND 'I25.9' OR
dso.DS1 BETWEEN 'I26' AND 'I26.9' OR
dso.DS1 BETWEEN 'I28' AND 'I28.9' OR
dso.DS1 BETWEEN 'I33' AND 'I33.9' OR
dso.DS1 BETWEEN 'I34' AND 'I34.9' OR
dso.DS1 BETWEEN 'I35' AND 'I35.9' OR
dso.DS1 BETWEEN 'I36' AND 'I36.9' OR
dso.DS1 BETWEEN 'I37' AND 'I37.9' OR
dso.DS1 BETWEEN 'I38' AND 'I38.9' OR
dso.DS1 BETWEEN 'I39' AND 'I39.9' OR
dso.DS1 BETWEEN 'I40' AND 'I40.9' OR
dso.DS1 BETWEEN 'I41' AND 'I41.9' OR
dso.DS1 BETWEEN 'I42' AND 'I42.9' OR
dso.DS1 BETWEEN 'I44' AND 'I44.9' OR
dso.DS1 BETWEEN 'I45' AND 'I45.9' OR
dso.DS1 BETWEEN 'I46' AND 'I46.9' OR
dso.DS1 BETWEEN 'I47' AND 'I47.9' OR
dso.DS1 BETWEEN 'I48' AND 'I48.9' OR
dso.DS1 BETWEEN 'I49' AND 'I49.9' OR
dso.DS1 BETWEEN 'I51' AND 'I51.2' OR
dso.DS1 BETWEEN 'I71' AND 'I71.9' OR
dso.DS1 BETWEEN 'Q20' AND 'Q28.9' OR
dso.DS1 BETWEEN 'E78' AND 'E78.9' 
) 
GROUP BY dpo.FAM, dpo.IM, dpo.OT, dr
) AS t ON t.FAM = d.FAM AND t.IM = d.IM AND t.OT = d.OT AND t.dr = d.dr


WHERE t.FAM IS NULL 
GROUP BY d.FAM, d.IM, d.OT, d.dr



SELECT d.FAM, d.IM, d.OT, d.dr, d.DS1, Min(d.DATE_Z_2)DATE_Z_2, d.IDDOKT, MIN(d.OS_SLUCH_REGION)OS_SLUCH_REGION
INTO ztemp_dd_po_doc
FROM ztemp_du_051023_1 t
JOIN (SELECT dpo.*, dpo.FAM, dpo.IM, dpo.OT, dr, dso.DS1, dzo.DATE_Z_2, dzo.OS_SLUCH_REGION, dso.IDDOKT
FROM D3_ZSL_OMS AS dzo
JOIN D3_SL_OMS AS dso ON dso.D3_ZSLID = dzo.ID
JOIN D3_PACIENT_OMS AS dpo ON dpo.ID = dzo.D3_PID
JOIN D3_SCHET_OMS AS dso2 ON dso2.ID = dzo.D3_SCID
WHERE dso2.[YEAR] = 2023 AND dso2.[MONTH] = 9
AND dzo.OS_SLUCH_REGION IN (47,49, 50)
 AND dso.PROFIL IN (97, 29, 53)
AND( dso.DS1 IN ('I27.0', 'I27.2', 'I27.8', 'I50.0', 'I50.1', 'I50.9', 'I51.4', 'I69.0','I69.1','I69.2','I69.3','I69.4','I67.8', 'I65.2',
'Z95.0', 'Z95.1', 'Z95.2', 'Z95.3', 'Z95.4','Z95.5', 'Z95.8', 'Z95.9') OR
dso.DS1 BETWEEN 'I05' AND 'I05.9' OR
dso.DS1 BETWEEN 'I06' AND 'I06.9' OR
dso.DS1 BETWEEN 'I07' AND 'I07.9' OR
dso.DS1 BETWEEN 'I08' AND 'I08.9' OR
dso.DS1 BETWEEN 'I09' AND 'I09.9' OR

dso.DS1 BETWEEN 'I10' AND 'I10.9' OR 
dso.DS1 BETWEEN 'I11' AND 'I11.9' OR 
dso.DS1 BETWEEN 'I12' AND 'I12.9' OR 
dso.DS1 BETWEEN 'I13' AND 'I13.9' OR 
dso.DS1 BETWEEN 'I15' AND 'I15.9' OR
dso.DS1 BETWEEN 'I20' AND 'I20.9' OR
dso.DS1 BETWEEN 'I21' AND 'I21.9' OR
dso.DS1 BETWEEN 'I22' AND 'I22.9' OR
dso.DS1 BETWEEN 'I23' AND 'I23.9' OR
dso.DS1 BETWEEN 'I24' AND 'I24.9' OR
dso.DS1 BETWEEN 'I25' AND 'I25.9' OR
dso.DS1 BETWEEN 'I26' AND 'I26.9' OR
dso.DS1 BETWEEN 'I28' AND 'I28.9' OR
dso.DS1 BETWEEN 'I33' AND 'I33.9' OR
dso.DS1 BETWEEN 'I34' AND 'I34.9' OR
dso.DS1 BETWEEN 'I35' AND 'I35.9' OR
dso.DS1 BETWEEN 'I36' AND 'I36.9' OR
dso.DS1 BETWEEN 'I37' AND 'I37.9' OR
dso.DS1 BETWEEN 'I38' AND 'I38.9' OR
dso.DS1 BETWEEN 'I39' AND 'I39.9' OR
dso.DS1 BETWEEN 'I40' AND 'I40.9' OR
dso.DS1 BETWEEN 'I41' AND 'I41.9' OR
dso.DS1 BETWEEN 'I42' AND 'I42.9' OR
dso.DS1 BETWEEN 'I44' AND 'I44.9' OR
dso.DS1 BETWEEN 'I45' AND 'I45.9' OR
dso.DS1 BETWEEN 'I46' AND 'I46.9' OR
dso.DS1 BETWEEN 'I47' AND 'I47.9' OR
dso.DS1 BETWEEN 'I48' AND 'I48.9' OR
dso.DS1 BETWEEN 'I49' AND 'I49.9' OR
dso.DS1 BETWEEN 'I51' AND 'I51.2' OR
dso.DS1 BETWEEN 'I71' AND 'I71.9' OR
dso.DS1 BETWEEN 'Q20' AND 'Q28.9' OR
dso.DS1 BETWEEN 'E78' AND 'E78.9' 
)

) AS d ON t.FAM = d.FAM AND t.IM = d.IM AND t.OT = d.OT AND t.dr = d.dr
GROUP BY d.FAM, d.IM, d.OT, d.dr, d.DS1, d.IDDOKT



SELECT *,
(SELECT TOP 1 ysme.NameWithID
   FROM Yamed_Spr_MedicalEmployee AS ysme WHERE ysme.SNILS = IDDOKT)IDDOKT_name
INTO ztemp_dd_po_doc_1
FROM ztemp_dd_po_doc 



SELECT tt.*, t.tel, ISNULL(ap.AdrOmsRn, '-') + ' ' + isnull(ap.AdrOmsNaspunkt, '-') + ' ' + isnull(ap.AdrOmsUl, '-') + ' ' + ISNULL(ap.AdrOmsDom, '-') + ' ' + isnull(ap.AdrOmsKorp, '-')  + ' ' + isnull(ap.AdrOmsKv, '-') addr
		--INTO ztemp_ztemp_du_bsk_adr
		FROM ztemp_dd_po_doc_1 tt 
		LEFT JOIN [SQL_COD].[DocExchange].[dbo].[ATTP_People] as ap ON ap.fam = tt.fam AND ap.im = tt.im AND ap.ot = tt.ot and ap.dr = tt.dr 
		LEFT JOIN [test].[dbo].[Tel] t ON tt.fam=f and tt.im=i and tt.ot=o and tt.dr=d